# 系統架構文檔

## 整體架構

```
┌─────────────────────────────────────────────────────────────┐
│                    知識智能系統                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   使用者輸入  │  │   知識庫     │  │   輸出結果    │      │
│  │  (問題/搜尋)  │  │ (JSON 文章)  │  │  (答案/報告)  │      │
│  └──────┬───────┘  └──────┬───────┘  └──────▲───────┘      │
│         │                 │                 │               │
│         ▼                 ▼                 │               │
│  ┌──────────────────────────────────────────┴──────┐       │
│  │                 主程式 (index.js)                │       │
│  │   - 命令解析                                     │       │
│  │   - 引擎初始化                                   │       │
│  │   - 結果格式化                                   │       │
│  └──────────────────────┬───────────────────────────┘       │
│                         │                                   │
│         ┌───────────────┼───────────────┐                   │
│         ▼               ▼               ▼                   │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐            │
│  │  搜尋引擎   │  │  分析引擎   │  │  問答引擎   │            │
│  │ (semantic) │  │ (analysis) │  │   (qa)     │            │
│  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘            │
│        │               │               │                    │
│        ▼               ▼               ▼                    │
│  ┌────────────────────────────────────────────────┐        │
│  │              向量化引擎 (embeddings)             │        │
│  │   - TF-IDF 向量化                               │        │
│  │   - 餘弦相似度計算                               │        │
│  └────────────────────────────────────────────────┘        │
│                         │                                   │
│                         ▼                                   │
│  ┌────────────────────────────────────────────────┐        │
│  │              文字處理 (utils/text)              │        │
│  │   - 中英文分詞                                  │        │
│  │   - 停用詞過濾                                  │        │
│  │   - 關鍵詞提取                                  │        │
│  └────────────────────────────────────────────────┘        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 模組說明

### 1. 文字處理模組 (utils/text.js)

**職責**：提供文字分析的基礎功能

**核心函數**：
- `tokenize()` - 中英文混合分詞
- `removeStopwords()` - 停用詞過濾
- `extractNgrams()` - N-gram 提取
- `termFrequency()` - 詞頻統計
- `cosineSimilarity()` - 餘弦相似度

**設計考量**：
- 同時支援中文和英文
- 中文採用字符級分詞（無需外部分詞器）
- 英文採用詞彙級分詞

### 2. 向量化模組 (embeddings/)

**職責**：將文章轉換為可比較的向量表示

**核心類別**：
- `TFIDFVectorizer` - TF-IDF 向量化器
- `VectorStore` - 向量持久化存儲

**演算法**：
- TF (詞頻) = 詞在文檔中出現次數 / 文檔最高詞頻
- IDF (逆文檔頻率) = log((總文檔數+1) / (包含該詞的文檔數+1)) + 1
- TF-IDF = TF × IDF

### 3. 搜尋引擎 (search/semantic.js)

**職責**：提供語意搜尋功能

**核心功能**：
- `search()` - 語意搜尋
- `findSimilar()` - 找相似文章
- `extractRelevantSnippets()` - 提取相關片段
- `clusterByTopic()` - 按主題分群

**搜尋流程**：
1. 將查詢向量化
2. 計算與所有文章的餘弦相似度
3. 排序並返回 Top-K 結果
4. 提取相關片段

### 4. 分析引擎 (analysis/)

**模組**：
- `trends.js` - 趨勢分析
- `connections.js` - 關聯發現
- `insights.js` - 洞見生成

**趨勢分析演算法**：
1. 計算近期（30天）vs 過去（30-60天）的文章數
2. 如果近期 > 過去 × 1.5 → rising
3. 如果近期 < 過去 × 0.5 → declining
4. 否則 → stable

**關聯計算**：
- 標籤重疊 (40%)
- 主題相似度 (40%)
- 關鍵觀點相似度 (20%)

### 5. 問答引擎 (qa/engine.js)

**職責**：基於知識庫回答問題

**問題類型識別**：
- definition - 定義解釋類
- comparison - 比較類
- listing - 列舉類
- reason - 原因類
- summary - 總結類
- trend - 趨勢類
- opinion - 觀點類
- general - 一般類

**回答流程**：
1. 分析問題類型
2. 提取關鍵主題
3. 語意搜尋相關文章
4. 根據問題類型生成答案
5. 附加來源引用

## 資料流

```
文章收藏
    │
    ▼
┌─────────────────────────────┐
│ 知識庫 (knowledge-base.json) │
│  - id, title, content       │
│  - summary, keyPoints       │
│  - tags, category           │
│  - savedAt, url             │
└──────────────┬──────────────┘
               │
               ▼
┌─────────────────────────────┐
│     向量化 & 索引            │
│  - 文字預處理                │
│  - TF-IDF 計算              │
│  - 向量存儲                  │
└──────────────┬──────────────┘
               │
    ┌──────────┼──────────┐
    ▼          ▼          ▼
┌────────┐ ┌────────┐ ┌────────┐
│ 搜尋   │ │ 分析   │ │ 問答   │
└────────┘ └────────┘ └────────┘
```

## 效能考量

1. **向量化快取**：訓練後的 TF-IDF 模型可持久化
2. **增量索引**：新文章可增量加入，無需重建全部
3. **延遲計算**：關聯圖譜在需要時才建立

## 擴展性

### 可替換的向量化後端
目前使用 TF-IDF，未來可替換為：
- OpenAI Embeddings
- Sentence Transformers
- Custom Embeddings

### 可擴展的分析模組
- 知識圖譜視覺化
- 自動標籤建議
- 閱讀模式分析

## 限制

1. **語意理解有限**：TF-IDF 是詞彙匹配，非真正的語意理解
2. **中文分詞簡化**：使用字符級分詞，可能損失詞彙語意
3. **知識庫規模**：目前設計適合數百篇文章，更大規模需優化
